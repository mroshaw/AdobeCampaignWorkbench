<%
  // ***********************************************************************
  // This perso block contains useful common functions for use in order
  // Message Center Templates
  // ***********************************************************************

  // Returns HTML for basic information for all lineItems for passed in to the function
  // Currently assumes that there can be more than one CONTACT_LENSES line item
  // If so, we assume that there are two entries for any given name, one for
  // Right Eye quantity, one for Left Eye quantity.
  function getLineItemsSummary(lineItems) {
    // Arrays of grouped Contact Lens items
    // name -> { leftQuantity: number, rightQuantity: number, seenLeft: bool, seenRight: bool }
    var clByGroup = {};
    // Preserve the order of first CL name
    var clOrder = [];
  
    // Build an array of output blocks (non-CL)
    var nonClSections = [];
  
    // Iterate all resolved line items
    for each (var lineItem in lineItems) {
  
      // We're only interested in physical products
      var category = lineItem.itemCategory;
      if (category == "LENS_ELEMENTS" || category == "LENS_TREATMENTS" || category == "LENSES") {
        continue;
      }
  
      if (category == "CONTACT_LENSES") {
        var name = lineItem.name;
        var groupId = lineItem.groupId;
        var eye = lineItem.eye;
        if(lineItem.deliveryQuantity != undefined) {
          var quantity = parseInt(String(lineItem.deliveryQuantity), 10);
        } else {
          var quantity = parseInt(String(lineItem.quantity), 10);
        }
        // If the group Id is not already in the array, then add it
        if (!clByGroup[groupId]) {
          clByGroup[groupId] = { leftQuantity: 0, rightQuantity: 0, seenLeft: false, seenRight: false };
          clOrder.push(groupId);
        }
        // Update the array for each of Left and Right eye, based on name found
        if (eye == "L") {
          clByGroup[groupId].leftQuantity += quantity;
          clByGroup[groupId].seenLeft = true;
        } else if (eye == "R") {
          clByGroup[groupId].rightQuantity += quantity;
          clByGroup[groupId].seenRight = true;
        } else if (eye == "LR") {
          clByGroup[groupId].leftQuantity += quantity;
          clByGroup[groupId].rightQuantity += quantity;
          clByGroup[groupId].seenLeft = true;
          clByGroup[groupId].seenRight = true;
        } else {
          // If eye is missing/unknown, assume its an LR (both).
          clByGroup[groupId].leftQuantity += quantity;
          clByGroup[groupId].rightQuantity += quantity;
          clByGroup[groupId].seenLeft = true;
          clByGroup[groupId].seenRight = true;
        }
        // Contact Lens arrays will be processed afterwards
        continue;
      }
  
      // Non-contact-lens item: add a block string to the buffer
      if(lineItem.deliveryQuantity != undefined) {
        var quantity = parseInt(String(lineItem.deliveryQuantity), 10);
      } else {
        var quantity = parseInt(String(lineItem.quantity), 10);
      }
      nonClSections.push(
        "<strong>Item:</strong> " + lineItem.name + "<br/>" +
        "<strong>Quantity:</strong> " + lineItem.quantity
      );
    } // end for each
  
    // Join non-CL blocks with a <br/><br/> separator
    var nonClCopy = nonClSections.join("<br/><br/>");
  
    // Build CL sections
    var clSections = [];
    for (var i = 0; i < clOrder.length; i++) {
      var groupId = clOrder[i];
      var clGroup = clByGroup[groupId];
  
      clSections.push(
        "<strong>Item:</strong> " + name + "<br/>" +
        "<strong>Quantity:</strong> Left " + clGroup.leftQuantity + ", " +
        "Right " + clGroup.rightQuantity
      );
    }
    // Join CL blocks (if any) with the same separator
    var clCopy = clSections.join("<br/><br/>");

    return {nonClCopy: nonClCopy, clCopy: clCopy};
  }
  //This function is used in ETM_M61_MCOrderDetailsCL ETM module to map the "frequency" of the CL to the correct translated values. These values are written in the ETM module. 
  function getFrequencyCL(event, frequency){
   var mappedValue;
   var countryCode=event.toString().slice(-2);
   if(countryCode=="gb" || countryCode=="ie" || countryCode=="au" || countryCode=="nz")
   {    
    switch(frequency){
        case "DAILY":
            mappedValue = "Daily disposables";
            break;
        case "MONTHLY":
            mappedValue = "Monthly disposables";
            break;
        case "TWICE_MONTHLY":
            mappedValue = "Twice monthly disposables";
            break;
        default:
            mappedValue = "ERROR - Value not configured in getFrequencyCL";
      }
    }else{
      mappedValue = "ERROR - No mapping for country code provided.getFrequencyCL ";
    }
    return mappedValue;
 }

  //This function is used in ETM Module 61. It calculates an array of items for CL grouped by groupId and product so it is easier to iterate in the ETM HTML to display the information. 
  function getCLItemsArray(groupId, lineItems)
  {      
      var arrayCL=[];
      var nameExistIndex;
      var i=-1;
      for each(lineItem in lineItems.lineItem)
      {
        if(parseInt(lineItem.groupId)==parseInt(groupId))
        {
          nameExistIndex=nameExistsIndex(arrayCL,lineItem.name.toString());
          if(nameExistIndex==-1){
            if(lineItem.productDetails.image!='')
            {
              itemImageLens='https://'+lineItem.productDetails.image;
            }else
            {
              itemImageLens="";
             }
            arrayCL.push({ name: lineItem.name.toString(), quantityLeft: 0, quantityRight: 0, replacementFrequency: lineItem.productDetails.replacementFrequency, packQuantity: lineItem.productDetails.packQuantity, totalPrice:lineItem.totalPrice.displayPrice, itemImageLens:itemImageLens, itemCategory:lineItem.itemCategory, unitPrice:lineItem.unitPrice.displayPrice });
            i++;
          }
          if(nameExistIndex==-1){nameExistIndex=i;} //if name is not found, the index will be the position where we have inserted the element, specified in i. If the name already exist, we keep the value returned by the function.
          if(lineItem.eye=='L')
          {
              arrayCL[nameExistIndex].quantityLeft=lineItem.quantity;
          }
          else if(lineItem.eye=='R')
          {
              arrayCL[nameExistIndex].quantityRight=lineItem.quantity;
          }
          
        }
        
      }
      return arrayCL;
  }
  //Returns the array position where the name is found. Otherwise returns -1
    function nameExistsIndex(arrayCL, nameToCheck) {
      for (var i = 0; i < arrayCL.length; i++) {
        if (arrayCL[i].name == nameToCheck) {
          return i;
        }
      }
      return -1;
    }
    
  //This function is used in ETM Module 61 to write the sentence "box of <quantity>" in the different languages.
  function getBoxOfQuantityText(event, quantity){
   var quantityString;
   var countryCode=event.toString().slice(-2);
   if(countryCode=="gb" || countryCode=="ie" || countryCode=="au" || countryCode=="nz")
   {    
      return "Box of " + quantity;
    }else{
      mappedValue = "ERROR - No mapping for country code provided.boxOfQuantityMapping ";
    }
    return quantityString;
 }

  //This function is used in the ETM Module 64 to write the sentence "X business days" in the different languages. It also calculates the number of days depending on glasses or other products.
  function getStandardDeliveryText(event, lineItemGroups)
  {
      var standardDays=0, standardText="";
      var countryCode=event.toString().slice(-2);
      for each(lineItemGroup in lineItemGroups.lineItemGroup)
      {
        if(lineItemGroup.type=='GLASSES')
        {
          standardDays=10;
        }
        else
        {
          standardDays=5;
        }
        break;
      }
       if(countryCode=="gb" || countryCode=="ie" || countryCode=="au" || countryCode=="nz")
       {
          standardText="("+standardDays + " business days)";
       }
       else
       {
          standardText="Standard text not configured for country used. Check function standardDeliveryText. Country code is " + countryCode;
       }
       return standardText;
      
  }
  
  //This function is used in the ETM Module 64 to get the text "you pay x/<frequency>" calculating how much the customer pays for the subscription depending on frequency
  function getSubscriptionPaymentText(event, subscription)
  {
    var paymentText="";
    var countryCode=event.toString().slice(-2);
    var displayPrice="";
    if(countryCode=="gb" || countryCode=="ie" || countryCode=="au" || countryCode=="nz")
    {
     if(subscription.unit.toString()=="MONTHS")
     {
        paymentText="/month";
     }     
    }
    else
     {
        paymentText="/no translation for specified country. Check getSubscriptionPaymentText function";
     }
    //get first instalments of the subscription to see how much the customer pay for it.
    for each(instalment in subscription.instalments.instalment)
    {
      displayPrice=instalment.amount.displayPrice;
      break;
    }
    paymentText=displayPrice+paymentText;
    return paymentText;

  }
  //This function is used in the ETM Module 64 to get the text "Payments are charged <frequency>"
  function getSubscriptionChargedFrequencyText(event, subscription)
  {
    var paymentText="";
     var countryCode=event.toString().slice(-2);
    if(countryCode=="gb" || countryCode=="ie" || countryCode=="au" || countryCode=="nz")
    {
     if(subscription.unit.toString()=="MONTHS")
     {
        paymentText="Payments are charged monthly";
     }
    }else
    {
      paymentText="No translation for the specified country. Check getSubscriptionChargedFrequencyText function.";
    }
    return paymentText;
   
  }

  function getSubscriptionRepeatText(event,subscription)
  {
    var subscriptionRepeatedText="";
    var countryCode=event.toString().slice(-2);
    if(countryCode=="gb" || countryCode=="ie" || countryCode=="au" || countryCode=="nz") {
      subscriptionRepeatedText="This order is part of a subscription and will automatically repeat every " + subscription.interval + " " + subscription.unit.toLowerCase();
    } else {
      subscriptionRepeatedText="No translation for the specified country. Check getSubscriptionRepeatText function.";
    }
    return subscriptionRepeatedText;
  }

%>